from functools import partial
from pathlib import Path

import matplotlib.pylab as plt
import numpy as np
import pandas as pd
import pytest
from dcegm.pre_processing import calc_current_value
from dcegm.upper_envelope import upper_envelope
from dcegm.upper_envelope_fast import fast_upper_envelope_wrapper
from dcegm.upper_envelope_fast_bug import fast_upper_envelope_wrapper_bug
from dcegm.upper_envelope_fast_org import fast_upper_envelope_wrapper_org
from numpy.testing import assert_array_almost_equal as aaae
from toy_models.consumption_retirement_model.utility_functions import utility_func_crra

# Obtain the test directory of the package.
TEST_DIR = Path(__file__).parent

# Directory with additional resources for the testing harness
TEST_RESOURCES_DIR = TEST_DIR / "resources"


@pytest.fixture()
def test_data():
    policy_out = np.array(
        [
            [
                0.0,
                5.52589268,
                5.66298055,
                5.80006842,
                5.93715629,
                6.07424416,
                6.21133203,
                6.3484199,
                6.48550777,
                6.62259564,
                6.75968351,
                6.89677138,
                7.03385925,
                7.17094712,
                7.308035,
                7.44512287,
                7.45956038,
                7.59664825,
                7.73373612,
                7.87082399,
                8.00791186,
                8.14499974,
                8.28208761,
                8.41917548,
                8.55626335,
                8.69335122,
                8.83043909,
                8.96752696,
                9.10461483,
                9.2417027,
                9.37879057,
                9.51587844,
                9.65296631,
                9.79005418,
                9.92714205,
                10.06422992,
                10.20131779,
                10.33840566,
                10.47549353,
                10.61258141,
                10.74966928,
                10.88675715,
                11.02384502,
                11.16093289,
                11.29802076,
                11.43510863,
                11.5721965,
                11.70928437,
                11.84637224,
                11.98346011,
                12.12054798,
                12.25763585,
                12.39472372,
                12.53181159,
                12.66889946,
                12.80598733,
                12.9430752,
                13.08016308,
                13.21725095,
                13.35433882,
                13.49142669,
                13.62851456,
                13.76560243,
                13.9026903,
                14.03977817,
                14.17686604,
                14.31395391,
                14.45104178,
                14.58812965,
                14.72521752,
                14.86230539,
                14.99939326,
                15.13648113,
                15.273569,
                15.41065687,
                15.54774475,
                15.68483262,
                15.82192049,
                15.95900836,
                16.09609623,
                16.2331841,
                16.37027197,
                16.50735984,
                16.64444771,
                16.78153558,
                16.91862345,
                17.05571132,
                17.19279919,
                17.32988706,
                17.46697493,
                17.6040628,
                17.74115067,
                17.87823854,
                18.01532641,
                18.15241429,
                18.28950216,
                18.42659003,
                18.5636779,
                18.70076577,
                18.83785364,
                18.97494151,
                19.11202938,
                19.24911725,
                19.38620512,
                19.52329299,
                19.66038086,
                19.79746873,
                19.9345566,
                20.07164447,
                20.20873234,
                20.34582021,
                20.48290808,
                20.61999596,
                20.75708383,
                20.8941717,
                21.03125957,
                21.16834744,
                21.30543531,
                21.44252318,
                21.57961105,
                21.71669892,
                21.85378679,
                21.99087466,
                22.12796253,
                22.2650504,
                22.40213827,
                22.53922614,
                22.67631401,
                22.81340188,
                22.95048975,
                23.08757763,
                23.2246655,
                23.36175337,
                23.49884124,
                23.63592911,
                23.77301698,
                23.91010485,
                24.04719272,
                24.18428059,
                24.32136846,
                24.45845633,
                24.5955442,
                24.73263207,
                24.86971994,
                25.00680781,
                25.14389568,
                25.28098355,
                25.41807142,
                25.5551593,
                25.69224717,
                25.82933504,
                25.96642291,
                26.10351078,
                26.24059865,
                26.37768652,
                26.51477439,
                26.65186226,
                26.78895013,
                26.926038,
                27.06312587,
                27.20021374,
                27.33730161,
                27.47438948,
                27.61147735,
                27.74856522,
                27.88565309,
                28.02274096,
                28.15982884,
                28.29691671,
                28.43400458,
                28.57109245,
                28.70818032,
                28.84526819,
                28.98235606,
                29.11944393,
                29.2565318,
                29.39361967,
                29.53070754,
                29.66779541,
                29.80488328,
                29.94197115,
                30.07905902,
                30.21614689,
                30.35323476,
                30.49032263,
                30.62741051,
                30.76449838,
                30.90158625,
                31.03867412,
                31.17576199,
                31.31284986,
                31.44993773,
                31.5870256,
                31.72411347,
                31.86120134,
                31.99828921,
                32.13537708,
                32.27246495,
                32.40955282,
                32.54664069,
                32.68372856,
                32.82081643,
                32.9579043,
                33.09499218,
                33.23208005,
                33.36916792,
                33.50625579,
                33.64334366,
                33.78043153,
                33.9175194,
                34.05460727,
                34.19169514,
                34.32878301,
                34.46587088,
                34.60295875,
                34.74004662,
                34.87713449,
                35.01422236,
                35.15131023,
                35.2883981,
                35.42548597,
                35.56257385,
                35.69966172,
                35.83674959,
                35.97383746,
                36.11092533,
                36.2480132,
                36.38510107,
                36.52218894,
                36.65927681,
                36.79636468,
                36.93345255,
                37.07054042,
                37.20762829,
                37.34471616,
                37.48180403,
                37.6188919,
                37.75597977,
                37.89306764,
                38.03015551,
                38.16724339,
                38.30433126,
                38.44141913,
                38.578507,
                38.71559487,
                38.85268274,
                38.98977061,
                39.12685848,
                39.26394635,
                39.40103422,
                39.53812209,
                39.67520996,
                39.81229783,
                39.9493857,
                40.08647357,
                40.22356144,
                40.36064931,
                40.49773718,
                40.63482506,
                40.77191293,
                40.9090008,
                41.04608867,
                41.18317654,
                41.32026441,
                41.45735228,
                41.59444015,
                41.73152802,
                41.86861589,
                42.00570376,
                42.14279163,
                42.2798795,
                42.41696737,
                42.55405524,
                42.69114311,
                42.82823098,
                42.96531885,
                43.10240673,
                43.2394946,
                43.37658247,
                43.51367034,
                43.65075821,
                43.78784608,
                43.92493395,
                44.06202182,
                44.19910969,
                44.33619756,
                44.47328543,
                44.6103733,
                44.74746117,
                44.88454904,
                45.02163691,
                45.15872478,
                45.29581265,
                45.43290052,
                45.5699884,
                45.70707627,
                45.84416414,
                45.98125201,
                46.11833988,
                46.25542775,
                46.39251562,
                46.52960349,
                46.66669136,
                46.80377923,
                46.9408671,
                47.07795497,
                47.21504284,
                47.35213071,
                47.48921858,
                47.62630645,
                47.76339432,
                47.90048219,
                48.03757006,
                48.17465794,
                48.31174581,
                48.44883368,
                48.58592155,
                48.72300942,
                48.86009729,
                48.99718516,
                49.13427303,
                49.2713609,
                49.40844877,
                49.54553664,
                49.68262451,
                49.81971238,
                49.95680025,
                50.09388812,
                50.23097599,
                50.36806386,
                50.50515173,
                50.64223961,
                50.77932748,
                50.91641535,
                51.05350322,
                51.19059109,
                51.32767896,
                51.46476683,
                51.6018547,
                51.73894257,
                51.87603044,
                52.01311831,
                52.15020618,
                52.28729405,
                52.42438192,
                52.56146979,
                52.69855766,
                52.83564553,
                52.9727334,
                53.10982128,
                53.24690915,
                53.38399702,
                53.52108489,
                53.65817276,
                53.79526063,
                53.9323485,
                54.06943637,
                54.20652424,
                54.34361211,
                54.48069998,
                54.61778785,
                54.75487572,
                54.89196359,
                55.02905146,
                55.16613933,
                55.3032272,
                55.44031507,
                55.57740295,
                55.71449082,
                55.85157869,
                55.98866656,
                56.12575443,
                56.2628423,
                56.39993017,
                56.53701804,
                56.67410591,
                56.81119378,
                56.94828165,
                57.08536952,
                57.22245739,
                57.35954526,
                57.49663313,
                57.633721,
                57.77080887,
                57.90789674,
                58.04498461,
                58.18207249,
                58.31916036,
                58.45624823,
                58.5933361,
                58.73042397,
                58.86751184,
                59.00459971,
                59.14168758,
                59.27877545,
                59.41586332,
                59.55295119,
                59.69003906,
                59.82712693,
                59.9642148,
                60.10130267,
                60.23839054,
                60.37547841,
                60.51256628,
                60.64965416,
                60.78674203,
                60.9238299,
                61.06091777,
                61.19800564,
                61.33509351,
                61.47218138,
                61.60926925,
                61.74635712,
                61.88344499,
                62.02053286,
                62.15762073,
                62.2947086,
                62.43179647,
                62.56888434,
                62.70597221,
                62.84306008,
                62.98014795,
                63.11723583,
                63.2543237,
                63.39141157,
                63.52849944,
                63.66558731,
                63.80267518,
                63.93976305,
                64.07685092,
                64.21393879,
                64.35102666,
                64.48811453,
                64.6252024,
                64.76229027,
                64.89937814,
                65.03646601,
                65.17355388,
                65.31064175,
                65.44772962,
                65.5848175,
                65.72190537,
                65.85899324,
                65.99608111,
                66.13316898,
                66.27025685,
                66.40734472,
                66.54443259,
                66.68152046,
                66.81860833,
                66.9556962,
                67.09278407,
                67.22987194,
                67.36695981,
                67.50404768,
                67.64113555,
                67.77822342,
                67.91531129,
                68.05239916,
                68.18948704,
                68.32657491,
                68.46366278,
                68.60075065,
                68.73783852,
                68.87492639,
                69.01201426,
                69.14910213,
                69.28619,
                69.42327787,
                69.56036574,
                69.69745361,
                69.83454148,
                69.97162935,
                70.10871722,
                70.24580509,
                70.38289296,
                70.51998083,
                70.65706871,
                70.79415658,
                70.93124445,
                71.06833232,
                71.20542019,
            ],
            [
                0.0,
                5.52589268,
                5.56278015,
                5.59966762,
                5.63655509,
                5.67344256,
                5.71033003,
                5.7472175,
                5.78410497,
                5.82099244,
                5.85787991,
                5.89476738,
                5.93165485,
                5.96854231,
                6.00542978,
                6.04231725,
                4.05274676,
                4.08963423,
                4.1265217,
                4.16340916,
                4.20029663,
                4.2371841,
                4.27407157,
                4.31095904,
                4.34784651,
                4.38473398,
                4.42162145,
                4.45850892,
                4.49539639,
                4.53228386,
                4.56917133,
                4.6060588,
                4.64294627,
                4.67983374,
                4.71672121,
                4.75360868,
                4.79049615,
                4.82738362,
                4.86427109,
                4.90115856,
                4.93804603,
                4.9749335,
                5.01182097,
                5.04870844,
                5.08559591,
                5.12248338,
                5.15937085,
                5.19625832,
                5.23314579,
                5.27003326,
                5.30692073,
                5.3438082,
                5.38069567,
                5.41758314,
                5.45447061,
                5.49135808,
                5.52824555,
                5.56513302,
                5.60202048,
                5.63890795,
                5.67579542,
                5.71268289,
                5.74957036,
                5.78645783,
                5.8233453,
                5.86023277,
                5.89712024,
                5.93400771,
                5.97089518,
                6.00778265,
                6.04467012,
                6.08155759,
                6.11844506,
                6.15533253,
                6.19222,
                6.22910747,
                6.26599494,
                6.30288241,
                6.33976988,
                6.37665735,
                6.41354482,
                6.45043229,
                6.48731976,
                6.52420723,
                6.5610947,
                6.59798217,
                6.63486964,
                6.67175711,
                6.70864458,
                6.74553205,
                6.78241952,
                6.81930699,
                6.85619446,
                6.89308193,
                6.9299694,
                6.96685687,
                7.00374434,
                7.0406318,
                7.07751927,
                7.11440674,
                7.15129421,
                7.18818168,
                7.22506915,
                7.26195662,
                7.29884409,
                7.33573156,
                7.37261903,
                7.4095065,
                7.44639397,
                7.48328144,
                7.52016891,
                7.55705638,
                7.59394385,
                7.63083132,
                7.66771879,
                7.70460626,
                7.74149373,
                7.7783812,
                7.81526867,
                7.85215614,
                7.88904361,
                7.92593108,
                7.96281855,
                7.99970602,
                8.03659349,
                8.07348096,
                8.11036843,
                8.1472559,
                8.18414337,
                8.22103084,
                8.25791831,
                8.29480578,
                8.33169325,
                8.36858072,
                8.40546819,
                8.44235566,
                8.47924313,
                8.51613059,
                8.55301806,
                8.58990553,
                8.626793,
                8.66368047,
                8.70056794,
                8.73745541,
                8.77434288,
                8.81123035,
                8.84811782,
                8.88500529,
                8.92189276,
                8.95878023,
                8.9956677,
                9.03255517,
                9.06944264,
                9.10633011,
                9.14321758,
                9.18010505,
                9.21699252,
                9.25387999,
                9.29076746,
                9.32765493,
                9.3645424,
                9.40142987,
                9.43831734,
                9.47520481,
                9.51209228,
                9.54897975,
                9.58586722,
                9.62275469,
                9.65964216,
                9.69652963,
                9.7334171,
                9.77030457,
                9.80719204,
                9.84407951,
                9.88096698,
                9.91785445,
                9.95474191,
                9.99162938,
                10.02851685,
                10.06540432,
                10.10229179,
                10.13917926,
                10.17606673,
                10.2129542,
                10.24984167,
                10.28672914,
                10.32361661,
                10.36050408,
                10.39739155,
                10.43427902,
                10.47116649,
                10.50805396,
                10.54494143,
                10.5818289,
                10.61871637,
                10.65560384,
                10.69249131,
                10.72937878,
                10.76626625,
                10.80315372,
                10.84004119,
                10.87692866,
                10.91381613,
                10.9507036,
                10.98759107,
                11.02447854,
                11.06136601,
                11.09825348,
                11.13514095,
                11.17202842,
                11.20891589,
                11.24580336,
                11.28269083,
                11.3195783,
                11.35646577,
                11.39335324,
                11.4302407,
                11.46712817,
                11.50401564,
                11.54090311,
                11.57779058,
                11.61467805,
                11.65156552,
                11.68845299,
                11.72534046,
                11.76222793,
                11.7991154,
                11.83600287,
                11.87289034,
                11.90977781,
                11.94666528,
                11.98355275,
                12.02044022,
                12.05732769,
                12.09421516,
                12.13110263,
                12.1679901,
                12.20487757,
                12.24176504,
                12.27865251,
                12.31553998,
                12.35242745,
                12.38931492,
                12.42620239,
                12.46308986,
                12.49997733,
                12.5368648,
                12.57375227,
                12.61063974,
                12.64752721,
                12.68441468,
                12.72130215,
                12.75818962,
                12.79507709,
                12.83196456,
                12.86885202,
                12.90573949,
                12.94262696,
                12.97951443,
                13.0164019,
                13.05328937,
                13.09017684,
                13.12706431,
                13.16395178,
                13.20083925,
                13.23772672,
                13.27461419,
                13.31150166,
                13.34838913,
                13.3852766,
                13.42216407,
                13.45905154,
                13.49593901,
                13.53282648,
                13.56971395,
                13.60660142,
                13.64348889,
                13.68037636,
                13.71726383,
                13.7541513,
                13.79103877,
                13.82792624,
                13.86481371,
                13.90170118,
                13.93858865,
                13.97547612,
                14.01236359,
                14.04925106,
                14.08613853,
                14.123026,
                14.15991347,
                14.19680094,
                14.23368841,
                14.27057588,
                14.30746335,
                14.34435081,
                14.38123828,
                14.41812575,
                14.45501322,
                14.49190069,
                14.52878816,
                14.56567563,
                14.6025631,
                14.63945057,
                14.67633804,
                14.71322551,
                14.75011298,
                14.78700045,
                14.82388792,
                14.86077539,
                14.89766286,
                14.93455033,
                14.9714378,
                15.00832527,
                15.04521274,
                15.08210021,
                15.11898768,
                15.15587515,
                15.19276262,
                15.22965009,
                15.26653756,
                15.30342503,
                15.3403125,
                15.37719997,
                15.41408744,
                15.45097491,
                15.48786238,
                15.52474985,
                15.56163732,
                15.59852479,
                15.63541226,
                15.67229973,
                15.7091872,
                15.74607467,
                15.78296213,
                15.8198496,
                15.85673707,
                15.89362454,
                15.93051201,
                15.96739948,
                16.00428695,
                16.04117442,
                16.07806189,
                16.11494936,
                16.15183683,
                16.1887243,
                16.22561177,
                16.26249924,
                16.29938671,
                16.33627418,
                16.37316165,
                16.41004912,
                16.44693659,
                16.48382406,
                16.52071153,
                16.557599,
                16.59448647,
                16.63137394,
                16.66826141,
                16.70514888,
                16.74203635,
                16.77892382,
                16.81581129,
                16.85269876,
                16.88958623,
                16.9264737,
                16.96336117,
                17.00024864,
                17.03713611,
                17.07402358,
                17.11091105,
                17.14779852,
                17.18468599,
                17.22157345,
                17.25846092,
                17.29534839,
                17.33223586,
                17.36912333,
                17.4060108,
                17.44289827,
                17.47978574,
                17.51667321,
                17.55356068,
                17.59044815,
                17.62733562,
                17.66422309,
                17.70111056,
                17.73799803,
                17.7748855,
                17.81177297,
                17.84866044,
                17.88554791,
                17.92243538,
                17.95932285,
                17.99621032,
                18.03309779,
                18.06998526,
                18.10687273,
                18.1437602,
                18.18064767,
                18.21753514,
                18.25442261,
                18.29131008,
                18.32819755,
                18.36508502,
                18.40197249,
                18.43885996,
                18.47574743,
                18.5126349,
                18.54952237,
                18.58640984,
                18.62329731,
                18.66018478,
                18.69707224,
                18.73395971,
                18.77084718,
                18.80773465,
                18.84462212,
                18.88150959,
                18.91839706,
                18.95528453,
                18.992172,
                19.02905947,
                19.06594694,
                19.10283441,
                19.13972188,
                19.17660935,
                19.21349682,
                19.25038429,
                19.28727176,
                19.32415923,
                19.3610467,
                19.39793417,
                19.43482164,
                19.47170911,
                19.50859658,
                19.54548405,
                19.58237152,
                19.61925899,
                19.65614646,
                19.69303393,
                19.7299214,
                19.76680887,
                19.80369634,
                19.84058381,
                19.87747128,
                19.91435875,
                19.95124622,
                19.98813369,
                20.02502116,
                20.06190863,
                20.0987961,
                20.13568356,
                20.17257103,
                20.2094585,
                20.24634597,
                20.28323344,
                20.32012091,
                20.35700838,
                20.39389585,
                20.43078332,
                20.46767079,
                20.50455826,
                20.54144573,
                20.5783332,
                20.61522067,
                20.65210814,
                20.68899561,
                20.72588308,
                20.76277055,
                20.79965802,
                20.83654549,
                20.87343296,
                20.91032043,
                20.9472079,
                20.98409537,
                21.02098284,
                21.05787031,
                21.09475778,
                21.13164525,
                21.16853272,
                21.20542019,
            ],
        ]
    )

    value_out = np.array(
        [
            [
                0.0,
                5.52589268,
                5.66298055,
                5.80006842,
                5.93715629,
                6.07424416,
                6.21133203,
                6.3484199,
                6.48550777,
                6.62259564,
                6.75968351,
                6.89677138,
                7.03385925,
                7.17094712,
                7.308035,
                7.44512287,
                7.45956038,
                7.59664825,
                7.73373612,
                7.87082399,
                8.00791186,
                8.14499974,
                8.28208761,
                8.41917548,
                8.55626335,
                8.69335122,
                8.83043909,
                8.96752696,
                9.10461483,
                9.2417027,
                9.37879057,
                9.51587844,
                9.65296631,
                9.79005418,
                9.92714205,
                10.06422992,
                10.20131779,
                10.33840566,
                10.47549353,
                10.61258141,
                10.74966928,
                10.88675715,
                11.02384502,
                11.16093289,
                11.29802076,
                11.43510863,
                11.5721965,
                11.70928437,
                11.84637224,
                11.98346011,
                12.12054798,
                12.25763585,
                12.39472372,
                12.53181159,
                12.66889946,
                12.80598733,
                12.9430752,
                13.08016308,
                13.21725095,
                13.35433882,
                13.49142669,
                13.62851456,
                13.76560243,
                13.9026903,
                14.03977817,
                14.17686604,
                14.31395391,
                14.45104178,
                14.58812965,
                14.72521752,
                14.86230539,
                14.99939326,
                15.13648113,
                15.273569,
                15.41065687,
                15.54774475,
                15.68483262,
                15.82192049,
                15.95900836,
                16.09609623,
                16.2331841,
                16.37027197,
                16.50735984,
                16.64444771,
                16.78153558,
                16.91862345,
                17.05571132,
                17.19279919,
                17.32988706,
                17.46697493,
                17.6040628,
                17.74115067,
                17.87823854,
                18.01532641,
                18.15241429,
                18.28950216,
                18.42659003,
                18.5636779,
                18.70076577,
                18.83785364,
                18.97494151,
                19.11202938,
                19.24911725,
                19.38620512,
                19.52329299,
                19.66038086,
                19.79746873,
                19.9345566,
                20.07164447,
                20.20873234,
                20.34582021,
                20.48290808,
                20.61999596,
                20.75708383,
                20.8941717,
                21.03125957,
                21.16834744,
                21.30543531,
                21.44252318,
                21.57961105,
                21.71669892,
                21.85378679,
                21.99087466,
                22.12796253,
                22.2650504,
                22.40213827,
                22.53922614,
                22.67631401,
                22.81340188,
                22.95048975,
                23.08757763,
                23.2246655,
                23.36175337,
                23.49884124,
                23.63592911,
                23.77301698,
                23.91010485,
                24.04719272,
                24.18428059,
                24.32136846,
                24.45845633,
                24.5955442,
                24.73263207,
                24.86971994,
                25.00680781,
                25.14389568,
                25.28098355,
                25.41807142,
                25.5551593,
                25.69224717,
                25.82933504,
                25.96642291,
                26.10351078,
                26.24059865,
                26.37768652,
                26.51477439,
                26.65186226,
                26.78895013,
                26.926038,
                27.06312587,
                27.20021374,
                27.33730161,
                27.47438948,
                27.61147735,
                27.74856522,
                27.88565309,
                28.02274096,
                28.15982884,
                28.29691671,
                28.43400458,
                28.57109245,
                28.70818032,
                28.84526819,
                28.98235606,
                29.11944393,
                29.2565318,
                29.39361967,
                29.53070754,
                29.66779541,
                29.80488328,
                29.94197115,
                30.07905902,
                30.21614689,
                30.35323476,
                30.49032263,
                30.62741051,
                30.76449838,
                30.90158625,
                31.03867412,
                31.17576199,
                31.31284986,
                31.44993773,
                31.5870256,
                31.72411347,
                31.86120134,
                31.99828921,
                32.13537708,
                32.27246495,
                32.40955282,
                32.54664069,
                32.68372856,
                32.82081643,
                32.9579043,
                33.09499218,
                33.23208005,
                33.36916792,
                33.50625579,
                33.64334366,
                33.78043153,
                33.9175194,
                34.05460727,
                34.19169514,
                34.32878301,
                34.46587088,
                34.60295875,
                34.74004662,
                34.87713449,
                35.01422236,
                35.15131023,
                35.2883981,
                35.42548597,
                35.56257385,
                35.69966172,
                35.83674959,
                35.97383746,
                36.11092533,
                36.2480132,
                36.38510107,
                36.52218894,
                36.65927681,
                36.79636468,
                36.93345255,
                37.07054042,
                37.20762829,
                37.34471616,
                37.48180403,
                37.6188919,
                37.75597977,
                37.89306764,
                38.03015551,
                38.16724339,
                38.30433126,
                38.44141913,
                38.578507,
                38.71559487,
                38.85268274,
                38.98977061,
                39.12685848,
                39.26394635,
                39.40103422,
                39.53812209,
                39.67520996,
                39.81229783,
                39.9493857,
                40.08647357,
                40.22356144,
                40.36064931,
                40.49773718,
                40.63482506,
                40.77191293,
                40.9090008,
                41.04608867,
                41.18317654,
                41.32026441,
                41.45735228,
                41.59444015,
                41.73152802,
                41.86861589,
                42.00570376,
                42.14279163,
                42.2798795,
                42.41696737,
                42.55405524,
                42.69114311,
                42.82823098,
                42.96531885,
                43.10240673,
                43.2394946,
                43.37658247,
                43.51367034,
                43.65075821,
                43.78784608,
                43.92493395,
                44.06202182,
                44.19910969,
                44.33619756,
                44.47328543,
                44.6103733,
                44.74746117,
                44.88454904,
                45.02163691,
                45.15872478,
                45.29581265,
                45.43290052,
                45.5699884,
                45.70707627,
                45.84416414,
                45.98125201,
                46.11833988,
                46.25542775,
                46.39251562,
                46.52960349,
                46.66669136,
                46.80377923,
                46.9408671,
                47.07795497,
                47.21504284,
                47.35213071,
                47.48921858,
                47.62630645,
                47.76339432,
                47.90048219,
                48.03757006,
                48.17465794,
                48.31174581,
                48.44883368,
                48.58592155,
                48.72300942,
                48.86009729,
                48.99718516,
                49.13427303,
                49.2713609,
                49.40844877,
                49.54553664,
                49.68262451,
                49.81971238,
                49.95680025,
                50.09388812,
                50.23097599,
                50.36806386,
                50.50515173,
                50.64223961,
                50.77932748,
                50.91641535,
                51.05350322,
                51.19059109,
                51.32767896,
                51.46476683,
                51.6018547,
                51.73894257,
                51.87603044,
                52.01311831,
                52.15020618,
                52.28729405,
                52.42438192,
                52.56146979,
                52.69855766,
                52.83564553,
                52.9727334,
                53.10982128,
                53.24690915,
                53.38399702,
                53.52108489,
                53.65817276,
                53.79526063,
                53.9323485,
                54.06943637,
                54.20652424,
                54.34361211,
                54.48069998,
                54.61778785,
                54.75487572,
                54.89196359,
                55.02905146,
                55.16613933,
                55.3032272,
                55.44031507,
                55.57740295,
                55.71449082,
                55.85157869,
                55.98866656,
                56.12575443,
                56.2628423,
                56.39993017,
                56.53701804,
                56.67410591,
                56.81119378,
                56.94828165,
                57.08536952,
                57.22245739,
                57.35954526,
                57.49663313,
                57.633721,
                57.77080887,
                57.90789674,
                58.04498461,
                58.18207249,
                58.31916036,
                58.45624823,
                58.5933361,
                58.73042397,
                58.86751184,
                59.00459971,
                59.14168758,
                59.27877545,
                59.41586332,
                59.55295119,
                59.69003906,
                59.82712693,
                59.9642148,
                60.10130267,
                60.23839054,
                60.37547841,
                60.51256628,
                60.64965416,
                60.78674203,
                60.9238299,
                61.06091777,
                61.19800564,
                61.33509351,
                61.47218138,
                61.60926925,
                61.74635712,
                61.88344499,
                62.02053286,
                62.15762073,
                62.2947086,
                62.43179647,
                62.56888434,
                62.70597221,
                62.84306008,
                62.98014795,
                63.11723583,
                63.2543237,
                63.39141157,
                63.52849944,
                63.66558731,
                63.80267518,
                63.93976305,
                64.07685092,
                64.21393879,
                64.35102666,
                64.48811453,
                64.6252024,
                64.76229027,
                64.89937814,
                65.03646601,
                65.17355388,
                65.31064175,
                65.44772962,
                65.5848175,
                65.72190537,
                65.85899324,
                65.99608111,
                66.13316898,
                66.27025685,
                66.40734472,
                66.54443259,
                66.68152046,
                66.81860833,
                66.9556962,
                67.09278407,
                67.22987194,
                67.36695981,
                67.50404768,
                67.64113555,
                67.77822342,
                67.91531129,
                68.05239916,
                68.18948704,
                68.32657491,
                68.46366278,
                68.60075065,
                68.73783852,
                68.87492639,
                69.01201426,
                69.14910213,
                69.28619,
                69.42327787,
                69.56036574,
                69.69745361,
                69.83454148,
                69.97162935,
                70.10871722,
                70.24580509,
                70.38289296,
                70.51998083,
                70.65706871,
                70.79415658,
                70.93124445,
                71.06833232,
                71.20542019,
            ],
            [
                2.05931703,
                2.45149424,
                2.45635048,
                2.461171,
                2.46588366,
                2.47055756,
                2.47519777,
                2.47973316,
                2.4842344,
                2.48869924,
                2.49307278,
                2.49741036,
                2.50170953,
                2.50593035,
                2.51011269,
                2.5142557,
                2.51983117,
                2.5287087,
                2.53743052,
                2.5459949,
                2.55442686,
                2.56270043,
                2.57083315,
                2.57885725,
                2.58671531,
                2.59444954,
                2.60209492,
                2.60956709,
                2.61693268,
                2.62422575,
                2.63133893,
                2.63836114,
                2.6453203,
                2.65210264,
                2.65880848,
                2.66545529,
                2.67193087,
                2.67834133,
                2.68469649,
                2.6908866,
                2.69702015,
                2.70309779,
                2.70902657,
                2.71490019,
                2.72071481,
                2.7264027,
                2.73203201,
                2.73760106,
                2.74306257,
                2.74846197,
                2.75380139,
                2.75904988,
                2.76423268,
                2.76935705,
                2.77440485,
                2.77938333,
                2.78430602,
                2.78916452,
                2.79395007,
                2.79868337,
                2.8033631,
                2.80796629,
                2.81252148,
                2.81702892,
                2.82146286,
                2.82585035,
                2.8301936,
                2.83446838,
                2.83869778,
                2.84288528,
                2.84700937,
                2.85108957,
                2.85512919,
                2.85911049,
                2.86304971,
                2.86694881,
                2.87079466,
                2.87460052,
                2.87836599,
                2.88208323,
                2.88576282,
                2.8894011,
                2.8929961,
                2.89655603,
                2.90007315,
                2.90355048,
                2.90699827,
                2.9103999,
                2.91376561,
                2.91710653,
                2.92039799,
                2.92365759,
                2.92689604,
                2.93008259,
                2.93324125,
                2.9363804,
                2.93946781,
                2.94253111,
                2.94557548,
                2.9485686,
                2.95154057,
                2.95449443,
                2.95739779,
                2.96028224,
                2.96314886,
                2.96596744,
                2.96876798,
                2.97154933,
                2.97428892,
                2.97700896,
                2.97970902,
                2.98237293,
                2.9850157,
                2.98763821,
                2.99022956,
                2.99279812,
                2.99534661,
                2.99786835,
                3.0003656,
                3.00284337,
                3.00529829,
                3.00772699,
                3.01013715,
                3.01252789,
                3.01489066,
                3.01723614,
                3.0195644,
                3.02186453,
                3.0241481,
                3.02641542,
                3.02865612,
                3.03088038,
                3.03308897,
                3.03527253,
                3.03743994,
                3.03959191,
                3.0417205,
                3.0438334,
                3.04593076,
                3.04800645,
                3.05006702,
                3.05211169,
                3.05413644,
                3.05614678,
                3.05814059,
                3.06011626,
                3.06207833,
                3.06402303,
                3.065951,
                3.06786709,
                3.06976434,
                3.07164629,
                3.07351816,
                3.07536957,
                3.07720716,
                3.07903574,
                3.0808431,
                3.0826383,
                3.08442481,
                3.08618989,
                3.08794428,
                3.08969015,
                3.09141454,
                3.0931294,
                3.09483602,
                3.09652123,
                3.09819778,
                3.09986647,
                3.10151393,
                3.10315335,
                3.10478423,
                3.10639645,
                3.10799986,
                3.10959431,
                3.11117242,
                3.11274091,
                3.11430023,
                3.11584532,
                3.11737992,
                3.11890537,
                3.12041846,
                3.12192018,
                3.12341295,
                3.12489505,
                3.12636485,
                3.12782606,
                3.12927811,
                3.13071692,
                3.13214766,
                3.1335704,
                3.13497929,
                3.13638059,
                3.13777427,
                3.13915472,
                3.14052758,
                3.141893,
                3.14324587,
                3.14459122,
                3.14592916,
                3.14725528,
                3.14857404,
                3.14988525,
                3.15118541,
                3.15247842,
                3.15376363,
                3.15503859,
                3.15630669,
                3.1575666,
                3.15881709,
                3.16006106,
                3.16129634,
                3.16252294,
                3.16374367,
                3.16495497,
                3.16615827,
                3.16735652,
                3.1685445,
                3.16972518,
                3.17090115,
                3.17206658,
                3.1732256,
                3.17437991,
                3.1755235,
                3.17666139,
                3.17779464,
                3.17891706,
                3.18003434,
                3.18114711,
                3.182249,
                3.18334617,
                3.18443901,
                3.18552099,
                3.18659854,
                3.18767156,
                3.18873466,
                3.18979305,
                3.19084668,
                3.19189155,
                3.19293125,
                3.19396605,
                3.19499317,
                3.19601462,
                3.19703115,
                3.19804097,
                3.1990446,
                3.20004339,
                3.20103635,
                3.20202257,
                3.20300413,
                3.20398065,
                3.20494988,
                3.2059147,
                3.20687519,
                3.20782781,
                3.20877637,
                3.20972079,
                3.21065761,
                3.21159037,
                3.21251906,
                3.21344049,
                3.21435789,
                3.21527119,
                3.21617763,
                3.21708008,
                3.21797834,
                3.21887014,
                3.21975805,
                3.2206416,
                3.22151911,
                3.22239289,
                3.22326204,
                3.22412561,
                3.22498562,
                3.22584069,
                3.22669063,
                3.22753726,
                3.22837856,
                3.22921507,
                3.23004865,
                3.23087648,
                3.23170002,
                3.23252069,
                3.23333545,
                3.23414639,
                3.23495447,
                3.23575649,
                3.23655509,
                3.23735086,
                3.23814047,
                3.23892698,
                3.23971072,
                3.24048826,
                3.24126291,
                3.2420349,
                3.24280067,
                3.2435637,
                3.24432405,
                3.2450785,
                3.24583014,
                3.24657894,
                3.24732252,
                3.24806301,
                3.24880055,
                3.2495335,
                3.25026304,
                3.25098962,
                3.25171216,
                3.25243096,
                3.25314685,
                3.25385921,
                3.25456748,
                3.25527294,
                3.25597533,
                3.25667328,
                3.25736856,
                3.2580612,
                3.25874902,
                3.25943438,
                3.26011727,
                3.26079534,
                3.26147103,
                3.26214426,
                3.26281288,
                3.26347912,
                3.26414287,
                3.26480224,
                3.26545925,
                3.26611371,
                3.26676401,
                3.26741202,
                3.26805734,
                3.26869877,
                3.26933798,
                3.26997434,
                3.27060708,
                3.27123769,
                3.27186524,
                3.27248947,
                3.27311169,
                3.27373059,
                3.2743464,
                3.27496033,
                3.27557077,
                3.27617846,
                3.27678425,
                3.27738643,
                3.27798615,
                3.27858397,
                3.27917808,
                3.27976997,
                3.28035998,
                3.2809462,
                3.28153038,
                3.28211273,
                3.28269124,
                3.28326785,
                3.28384268,
                3.28441366,
                3.28498283,
                3.28555026,
                3.2861139,
                3.28667574,
                3.28723575,
                3.28779239,
                3.28834703,
                3.28889978,
                3.28944955,
                3.28999711,
                3.29054275,
                3.29108578,
                3.29162637,
                3.29216508,
                3.29270148,
                3.29323522,
                3.29376713,
                3.29429704,
                3.29482404,
                3.29534931,
                3.29587284,
                3.2963932,
                3.29691197,
                3.29742915,
                3.29794307,
                3.29845548,
                3.29896631,
                3.29947401,
                3.29998019,
                3.30048477,
                3.30098635,
                3.30148644,
                3.30198487,
                3.30248046,
                3.30297458,
                3.30346695,
                3.30395664,
                3.30444492,
                3.30493133,
                3.30541523,
                3.30589779,
                3.30637832,
                3.30685655,
                3.30733346,
                3.30780821,
                3.30828085,
                3.30875219,
                3.30922127,
                3.30968847,
                3.31015435,
                3.31061787,
                3.31107972,
                3.31154023,
                3.31199831,
                3.31245487,
                3.31291011,
                3.31336287,
                3.31381422,
                3.31426427,
                3.31471181,
                3.31515803,
                3.31560299,
                3.31604542,
                3.31648658,
                3.31692653,
                3.31736394,
                3.31780011,
                3.31823503,
                3.31866764,
                3.3190989,
                3.31952885,
                3.31995677,
                3.32038318,
                3.32080827,
                3.32123157,
                3.3216532,
                3.32207353,
                3.32249228,
                3.3229092,
                3.32332486,
                3.32373914,
                3.32415141,
                3.32456249,
                3.32497237,
                3.32538006,
                3.32578665,
                3.32619218,
                3.32659537,
                3.32699756,
                3.32739869,
                3.32779756,
                3.32819543,
                3.32859222,
                3.32898684,
                3.32938047,
                3.32977298,
                3.33016343,
                3.3305529,
                3.33094118,
                3.33132752,
                3.33171291,
                3.33209702,
                3.33247931,
                3.3328607,
                3.33324069,
                3.333619,
                3.3339964,
                3.33437234,
                3.33474677,
                3.33512024,
                3.33549219,
                3.3358628,
                3.33623242,
                3.33660046,
                3.33696729,
                3.33733313,
                3.33769732,
                3.33806042,
                3.33842253,
                3.33878296,
                3.33914236,
                3.33950081,
                3.33985754,
                3.3402133,
            ],
        ]
    )

    #
    endog_grid = np.array(
        [
            0.0,
            5.52589268,
            5.66298055,
            5.80006842,
            5.93715629,
            6.07424416,
            6.21133203,
            6.3484199,
            6.48550777,
            6.62259564,
            6.75968351,
            6.89677138,
            7.03385925,
            7.17094712,
            7.308035,
            7.44512287,
            7.58221074,
            7.71929861,
            7.85638648,
            7.99347435,
            8.13056222,
            8.26765009,
            8.40473796,
            8.54182583,
            8.6789137,
            8.81600157,
            8.95308944,
            6.36285742,
            6.49994529,
            6.63703316,
            6.77412103,
            6.9112089,
            7.04829677,
            7.18538464,
            7.32247251,
            7.45956038,
            7.59664825,
            7.73373612,
            7.87082399,
            8.00791186,
            8.14499974,
            8.28208761,
            8.41917548,
            8.55626335,
            8.69335122,
            8.83043909,
            8.96752696,
            9.10461483,
            9.2417027,
            9.37879057,
            9.51587844,
            9.65296631,
            9.79005418,
            9.92714205,
            10.06422992,
            10.20131779,
            10.33840566,
            10.47549353,
            10.61258141,
            10.74966928,
            10.88675715,
            11.02384502,
            11.16093289,
            11.29802076,
            11.43510863,
            11.5721965,
            11.70928437,
            11.84637224,
            11.98346011,
            12.12054798,
            12.25763585,
            12.39472372,
            12.53181159,
            12.66889946,
            12.80598733,
            12.9430752,
            13.08016308,
            13.21725095,
            13.35433882,
            13.49142669,
            13.62851456,
            13.76560243,
            13.9026903,
            14.03977817,
            14.17686604,
            14.31395391,
            14.45104178,
            14.58812965,
            14.72521752,
            14.86230539,
            14.99939326,
            15.13648113,
            15.273569,
            15.41065687,
            15.54774475,
            15.68483262,
            15.82192049,
            15.95900836,
            16.09609623,
            16.2331841,
            16.37027197,
            16.50735984,
            16.64444771,
            16.78153558,
            16.91862345,
            17.05571132,
            17.19279919,
            17.32988706,
            17.46697493,
            17.6040628,
            17.74115067,
            17.87823854,
            18.01532641,
            18.15241429,
            18.28950216,
            18.42659003,
            18.5636779,
            18.70076577,
            18.83785364,
            18.97494151,
            19.11202938,
            19.24911725,
            19.38620512,
            19.52329299,
            19.66038086,
            19.79746873,
            19.9345566,
            20.07164447,
            20.20873234,
            20.34582021,
            20.48290808,
            20.61999596,
            20.75708383,
            20.8941717,
            21.03125957,
            21.16834744,
            21.30543531,
            21.44252318,
            21.57961105,
            21.71669892,
            21.85378679,
            21.99087466,
            22.12796253,
            22.2650504,
            22.40213827,
            22.53922614,
            22.67631401,
            22.81340188,
            22.95048975,
            23.08757763,
            23.2246655,
            23.36175337,
            23.49884124,
            23.63592911,
            23.77301698,
            23.91010485,
            24.04719272,
            24.18428059,
            24.32136846,
            24.45845633,
            24.5955442,
            24.73263207,
            24.86971994,
            25.00680781,
            25.14389568,
            25.28098355,
            25.41807142,
            25.5551593,
            25.69224717,
            25.82933504,
            25.96642291,
            26.10351078,
            26.24059865,
            26.37768652,
            26.51477439,
            26.65186226,
            26.78895013,
            26.926038,
            27.06312587,
            27.20021374,
            27.33730161,
            27.47438948,
            27.61147735,
            27.74856522,
            27.88565309,
            28.02274096,
            28.15982884,
            28.29691671,
            28.43400458,
            28.57109245,
            28.70818032,
            28.84526819,
            28.98235606,
            29.11944393,
            29.2565318,
            29.39361967,
            29.53070754,
            29.66779541,
            29.80488328,
            29.94197115,
            30.07905902,
            30.21614689,
            30.35323476,
            30.49032263,
            30.62741051,
            30.76449838,
            30.90158625,
            31.03867412,
            31.17576199,
            31.31284986,
            31.44993773,
            31.5870256,
            31.72411347,
            31.86120134,
            31.99828921,
            32.13537708,
            32.27246495,
            32.40955282,
            32.54664069,
            32.68372856,
            32.82081643,
            32.9579043,
            33.09499218,
            33.23208005,
            33.36916792,
            33.50625579,
            33.64334366,
            33.78043153,
            33.9175194,
            34.05460727,
            34.19169514,
            34.32878301,
            34.46587088,
            34.60295875,
            34.74004662,
            34.87713449,
            35.01422236,
            35.15131023,
            35.2883981,
            35.42548597,
            35.56257385,
            35.69966172,
            35.83674959,
            35.97383746,
            36.11092533,
            36.2480132,
            36.38510107,
            36.52218894,
            36.65927681,
            36.79636468,
            36.93345255,
            37.07054042,
            37.20762829,
            37.34471616,
            37.48180403,
            37.6188919,
            37.75597977,
            37.89306764,
            38.03015551,
            38.16724339,
            38.30433126,
            38.44141913,
            38.578507,
            38.71559487,
            38.85268274,
            38.98977061,
            39.12685848,
            39.26394635,
            39.40103422,
            39.53812209,
            39.67520996,
            39.81229783,
            39.9493857,
            40.08647357,
            40.22356144,
            40.36064931,
            40.49773718,
            40.63482506,
            40.77191293,
            40.9090008,
            41.04608867,
            41.18317654,
            41.32026441,
            41.45735228,
            41.59444015,
            41.73152802,
            41.86861589,
            42.00570376,
            42.14279163,
            42.2798795,
            42.41696737,
            42.55405524,
            42.69114311,
            42.82823098,
            42.96531885,
            43.10240673,
            43.2394946,
            43.37658247,
            43.51367034,
            43.65075821,
            43.78784608,
            43.92493395,
            44.06202182,
            44.19910969,
            44.33619756,
            44.47328543,
            44.6103733,
            44.74746117,
            44.88454904,
            45.02163691,
            45.15872478,
            45.29581265,
            45.43290052,
            45.5699884,
            45.70707627,
            45.84416414,
            45.98125201,
            46.11833988,
            46.25542775,
            46.39251562,
            46.52960349,
            46.66669136,
            46.80377923,
            46.9408671,
            47.07795497,
            47.21504284,
            47.35213071,
            47.48921858,
            47.62630645,
            47.76339432,
            47.90048219,
            48.03757006,
            48.17465794,
            48.31174581,
            48.44883368,
            48.58592155,
            48.72300942,
            48.86009729,
            48.99718516,
            49.13427303,
            49.2713609,
            49.40844877,
            49.54553664,
            49.68262451,
            49.81971238,
            49.95680025,
            50.09388812,
            50.23097599,
            50.36806386,
            50.50515173,
            50.64223961,
            50.77932748,
            50.91641535,
            51.05350322,
            51.19059109,
            51.32767896,
            51.46476683,
            51.6018547,
            51.73894257,
            51.87603044,
            52.01311831,
            52.15020618,
            52.28729405,
            52.42438192,
            52.56146979,
            52.69855766,
            52.83564553,
            52.9727334,
            53.10982128,
            53.24690915,
            53.38399702,
            53.52108489,
            53.65817276,
            53.79526063,
            53.9323485,
            54.06943637,
            54.20652424,
            54.34361211,
            54.48069998,
            54.61778785,
            54.75487572,
            54.89196359,
            55.02905146,
            55.16613933,
            55.3032272,
            55.44031507,
            55.57740295,
            55.71449082,
            55.85157869,
            55.98866656,
            56.12575443,
            56.2628423,
            56.39993017,
            56.53701804,
            56.67410591,
            56.81119378,
            56.94828165,
            57.08536952,
            57.22245739,
            57.35954526,
            57.49663313,
            57.633721,
            57.77080887,
            57.90789674,
            58.04498461,
            58.18207249,
            58.31916036,
            58.45624823,
            58.5933361,
            58.73042397,
            58.86751184,
            59.00459971,
            59.14168758,
            59.27877545,
            59.41586332,
            59.55295119,
            59.69003906,
            59.82712693,
            59.9642148,
            60.10130267,
            60.23839054,
            60.37547841,
            60.51256628,
            60.64965416,
            60.78674203,
            60.9238299,
            61.06091777,
            61.19800564,
            61.33509351,
            61.47218138,
            61.60926925,
            61.74635712,
            61.88344499,
            62.02053286,
            62.15762073,
            62.2947086,
            62.43179647,
            62.56888434,
            62.70597221,
            62.84306008,
            62.98014795,
            63.11723583,
            63.2543237,
            63.39141157,
            63.52849944,
            63.66558731,
            63.80267518,
            63.93976305,
            64.07685092,
            64.21393879,
            64.35102666,
            64.48811453,
            64.6252024,
            64.76229027,
            64.89937814,
            65.03646601,
            65.17355388,
            65.31064175,
            65.44772962,
            65.5848175,
            65.72190537,
            65.85899324,
            65.99608111,
            66.13316898,
            66.27025685,
            66.40734472,
            66.54443259,
            66.68152046,
            66.81860833,
            66.9556962,
            67.09278407,
            67.22987194,
            67.36695981,
            67.50404768,
            67.64113555,
            67.77822342,
            67.91531129,
            68.05239916,
            68.18948704,
            68.32657491,
            68.46366278,
            68.60075065,
            68.73783852,
            68.87492639,
            69.01201426,
            69.14910213,
            69.28619,
            69.42327787,
            69.56036574,
            69.69745361,
            69.83454148,
            69.97162935,
            70.10871722,
            70.24580509,
            70.38289296,
            70.51998083,
            70.65706871,
            70.79415658,
            70.93124445,
            71.06833232,
            71.20542019,
        ]
    )

    _policy_egm = np.array(
        [
            0.0,
            5.52589268,
            5.56278015,
            5.59966762,
            5.63655509,
            5.67344256,
            5.71033003,
            5.7472175,
            5.78410497,
            5.82099244,
            5.85787991,
            5.89476738,
            5.93165485,
            5.96854231,
            6.00542978,
            6.04231725,
            6.07920472,
            6.11609219,
            6.15297966,
            6.18986713,
            6.2267546,
            6.26364207,
            6.30052954,
            6.33741701,
            6.37430448,
            6.41119195,
            6.44807942,
            3.757647,
            3.79453447,
            3.83142194,
            3.86830941,
            3.90519688,
            3.94208435,
            3.97897182,
            4.01585929,
            4.05274676,
            4.08963423,
            4.1265217,
            4.16340916,
            4.20029663,
            4.2371841,
            4.27407157,
            4.31095904,
            4.34784651,
            4.38473398,
            4.42162145,
            4.45850892,
            4.49539639,
            4.53228386,
            4.56917133,
            4.6060588,
            4.64294627,
            4.67983374,
            4.71672121,
            4.75360868,
            4.79049615,
            4.82738362,
            4.86427109,
            4.90115856,
            4.93804603,
            4.9749335,
            5.01182097,
            5.04870844,
            5.08559591,
            5.12248338,
            5.15937085,
            5.19625832,
            5.23314579,
            5.27003326,
            5.30692073,
            5.3438082,
            5.38069567,
            5.41758314,
            5.45447061,
            5.49135808,
            5.52824555,
            5.56513302,
            5.60202048,
            5.63890795,
            5.67579542,
            5.71268289,
            5.74957036,
            5.78645783,
            5.8233453,
            5.86023277,
            5.89712024,
            5.93400771,
            5.97089518,
            6.00778265,
            6.04467012,
            6.08155759,
            6.11844506,
            6.15533253,
            6.19222,
            6.22910747,
            6.26599494,
            6.30288241,
            6.33976988,
            6.37665735,
            6.41354482,
            6.45043229,
            6.48731976,
            6.52420723,
            6.5610947,
            6.59798217,
            6.63486964,
            6.67175711,
            6.70864458,
            6.74553205,
            6.78241952,
            6.81930699,
            6.85619446,
            6.89308193,
            6.9299694,
            6.96685687,
            7.00374434,
            7.0406318,
            7.07751927,
            7.11440674,
            7.15129421,
            7.18818168,
            7.22506915,
            7.26195662,
            7.29884409,
            7.33573156,
            7.37261903,
            7.4095065,
            7.44639397,
            7.48328144,
            7.52016891,
            7.55705638,
            7.59394385,
            7.63083132,
            7.66771879,
            7.70460626,
            7.74149373,
            7.7783812,
            7.81526867,
            7.85215614,
            7.88904361,
            7.92593108,
            7.96281855,
            7.99970602,
            8.03659349,
            8.07348096,
            8.11036843,
            8.1472559,
            8.18414337,
            8.22103084,
            8.25791831,
            8.29480578,
            8.33169325,
            8.36858072,
            8.40546819,
            8.44235566,
            8.47924313,
            8.51613059,
            8.55301806,
            8.58990553,
            8.626793,
            8.66368047,
            8.70056794,
            8.73745541,
            8.77434288,
            8.81123035,
            8.84811782,
            8.88500529,
            8.92189276,
            8.95878023,
            8.9956677,
            9.03255517,
            9.06944264,
            9.10633011,
            9.14321758,
            9.18010505,
            9.21699252,
            9.25387999,
            9.29076746,
            9.32765493,
            9.3645424,
            9.40142987,
            9.43831734,
            9.47520481,
            9.51209228,
            9.54897975,
            9.58586722,
            9.62275469,
            9.65964216,
            9.69652963,
            9.7334171,
            9.77030457,
            9.80719204,
            9.84407951,
            9.88096698,
            9.91785445,
            9.95474191,
            9.99162938,
            10.02851685,
            10.06540432,
            10.10229179,
            10.13917926,
            10.17606673,
            10.2129542,
            10.24984167,
            10.28672914,
            10.32361661,
            10.36050408,
            10.39739155,
            10.43427902,
            10.47116649,
            10.50805396,
            10.54494143,
            10.5818289,
            10.61871637,
            10.65560384,
            10.69249131,
            10.72937878,
            10.76626625,
            10.80315372,
            10.84004119,
            10.87692866,
            10.91381613,
            10.9507036,
            10.98759107,
            11.02447854,
            11.06136601,
            11.09825348,
            11.13514095,
            11.17202842,
            11.20891589,
            11.24580336,
            11.28269083,
            11.3195783,
            11.35646577,
            11.39335324,
            11.4302407,
            11.46712817,
            11.50401564,
            11.54090311,
            11.57779058,
            11.61467805,
            11.65156552,
            11.68845299,
            11.72534046,
            11.76222793,
            11.7991154,
            11.83600287,
            11.87289034,
            11.90977781,
            11.94666528,
            11.98355275,
            12.02044022,
            12.05732769,
            12.09421516,
            12.13110263,
            12.1679901,
            12.20487757,
            12.24176504,
            12.27865251,
            12.31553998,
            12.35242745,
            12.38931492,
            12.42620239,
            12.46308986,
            12.49997733,
            12.5368648,
            12.57375227,
            12.61063974,
            12.64752721,
            12.68441468,
            12.72130215,
            12.75818962,
            12.79507709,
            12.83196456,
            12.86885202,
            12.90573949,
            12.94262696,
            12.97951443,
            13.0164019,
            13.05328937,
            13.09017684,
            13.12706431,
            13.16395178,
            13.20083925,
            13.23772672,
            13.27461419,
            13.31150166,
            13.34838913,
            13.3852766,
            13.42216407,
            13.45905154,
            13.49593901,
            13.53282648,
            13.56971395,
            13.60660142,
            13.64348889,
            13.68037636,
            13.71726383,
            13.7541513,
            13.79103877,
            13.82792624,
            13.86481371,
            13.90170118,
            13.93858865,
            13.97547612,
            14.01236359,
            14.04925106,
            14.08613853,
            14.123026,
            14.15991347,
            14.19680094,
            14.23368841,
            14.27057588,
            14.30746335,
            14.34435081,
            14.38123828,
            14.41812575,
            14.45501322,
            14.49190069,
            14.52878816,
            14.56567563,
            14.6025631,
            14.63945057,
            14.67633804,
            14.71322551,
            14.75011298,
            14.78700045,
            14.82388792,
            14.86077539,
            14.89766286,
            14.93455033,
            14.9714378,
            15.00832527,
            15.04521274,
            15.08210021,
            15.11898768,
            15.15587515,
            15.19276262,
            15.22965009,
            15.26653756,
            15.30342503,
            15.3403125,
            15.37719997,
            15.41408744,
            15.45097491,
            15.48786238,
            15.52474985,
            15.56163732,
            15.59852479,
            15.63541226,
            15.67229973,
            15.7091872,
            15.74607467,
            15.78296213,
            15.8198496,
            15.85673707,
            15.89362454,
            15.93051201,
            15.96739948,
            16.00428695,
            16.04117442,
            16.07806189,
            16.11494936,
            16.15183683,
            16.1887243,
            16.22561177,
            16.26249924,
            16.29938671,
            16.33627418,
            16.37316165,
            16.41004912,
            16.44693659,
            16.48382406,
            16.52071153,
            16.557599,
            16.59448647,
            16.63137394,
            16.66826141,
            16.70514888,
            16.74203635,
            16.77892382,
            16.81581129,
            16.85269876,
            16.88958623,
            16.9264737,
            16.96336117,
            17.00024864,
            17.03713611,
            17.07402358,
            17.11091105,
            17.14779852,
            17.18468599,
            17.22157345,
            17.25846092,
            17.29534839,
            17.33223586,
            17.36912333,
            17.4060108,
            17.44289827,
            17.47978574,
            17.51667321,
            17.55356068,
            17.59044815,
            17.62733562,
            17.66422309,
            17.70111056,
            17.73799803,
            17.7748855,
            17.81177297,
            17.84866044,
            17.88554791,
            17.92243538,
            17.95932285,
            17.99621032,
            18.03309779,
            18.06998526,
            18.10687273,
            18.1437602,
            18.18064767,
            18.21753514,
            18.25442261,
            18.29131008,
            18.32819755,
            18.36508502,
            18.40197249,
            18.43885996,
            18.47574743,
            18.5126349,
            18.54952237,
            18.58640984,
            18.62329731,
            18.66018478,
            18.69707224,
            18.73395971,
            18.77084718,
            18.80773465,
            18.84462212,
            18.88150959,
            18.91839706,
            18.95528453,
            18.992172,
            19.02905947,
            19.06594694,
            19.10283441,
            19.13972188,
            19.17660935,
            19.21349682,
            19.25038429,
            19.28727176,
            19.32415923,
            19.3610467,
            19.39793417,
            19.43482164,
            19.47170911,
            19.50859658,
            19.54548405,
            19.58237152,
            19.61925899,
            19.65614646,
            19.69303393,
            19.7299214,
            19.76680887,
            19.80369634,
            19.84058381,
            19.87747128,
            19.91435875,
            19.95124622,
            19.98813369,
            20.02502116,
            20.06190863,
            20.0987961,
            20.13568356,
            20.17257103,
            20.2094585,
            20.24634597,
            20.28323344,
            20.32012091,
            20.35700838,
            20.39389585,
            20.43078332,
            20.46767079,
            20.50455826,
            20.54144573,
            20.5783332,
            20.61522067,
            20.65210814,
            20.68899561,
            20.72588308,
            20.76277055,
            20.79965802,
            20.83654549,
            20.87343296,
            20.91032043,
            20.9472079,
            20.98409537,
            21.02098284,
            21.05787031,
            21.09475778,
            21.13164525,
            21.16853272,
            21.20542019,
        ]
    )

    _value_egm = np.array(
        [
            2.05931703,
            2.45149424,
            2.45635048,
            2.461171,
            2.46588366,
            2.47055756,
            2.47519777,
            2.47973316,
            2.4842344,
            2.48869924,
            2.49307278,
            2.49741036,
            2.50170953,
            2.50593035,
            2.51011269,
            2.5142557,
            2.51833174,
            2.52236666,
            2.52636232,
            2.53030097,
            2.53419579,
            2.53805225,
            2.54186039,
            2.54562197,
            2.54934679,
            2.55303086,
            2.55666561,
            2.44271185,
            2.45301246,
            2.46308283,
            2.47297534,
            2.4827064,
            2.49223383,
            2.50159731,
            2.51080362,
            2.51983117,
            2.5287087,
            2.53743052,
            2.5459949,
            2.55442686,
            2.56270043,
            2.57083315,
            2.57885725,
            2.58671531,
            2.59444954,
            2.60209492,
            2.60956709,
            2.61693268,
            2.62422575,
            2.63133893,
            2.63836114,
            2.6453203,
            2.65210264,
            2.65880848,
            2.66545529,
            2.67193087,
            2.67834133,
            2.68469649,
            2.6908866,
            2.69702015,
            2.70309779,
            2.70902657,
            2.71490019,
            2.72071481,
            2.7264027,
            2.73203201,
            2.73760106,
            2.74306257,
            2.74846197,
            2.75380139,
            2.75904988,
            2.76423268,
            2.76935705,
            2.77440485,
            2.77938333,
            2.78430602,
            2.78916452,
            2.79395007,
            2.79868337,
            2.8033631,
            2.80796629,
            2.81252148,
            2.81702892,
            2.82146286,
            2.82585035,
            2.8301936,
            2.83446838,
            2.83869778,
            2.84288528,
            2.84700937,
            2.85108957,
            2.85512919,
            2.85911049,
            2.86304971,
            2.86694881,
            2.87079466,
            2.87460052,
            2.87836599,
            2.88208323,
            2.88576282,
            2.8894011,
            2.8929961,
            2.89655603,
            2.90007315,
            2.90355048,
            2.90699827,
            2.9103999,
            2.91376561,
            2.91710653,
            2.92039799,
            2.92365759,
            2.92689604,
            2.93008259,
            2.93324125,
            2.9363804,
            2.93946781,
            2.94253111,
            2.94557548,
            2.9485686,
            2.95154057,
            2.95449443,
            2.95739779,
            2.96028224,
            2.96314886,
            2.96596744,
            2.96876798,
            2.97154933,
            2.97428892,
            2.97700896,
            2.97970902,
            2.98237293,
            2.9850157,
            2.98763821,
            2.99022956,
            2.99279812,
            2.99534661,
            2.99786835,
            3.0003656,
            3.00284337,
            3.00529829,
            3.00772699,
            3.01013715,
            3.01252789,
            3.01489066,
            3.01723614,
            3.0195644,
            3.02186453,
            3.0241481,
            3.02641542,
            3.02865612,
            3.03088038,
            3.03308897,
            3.03527253,
            3.03743994,
            3.03959191,
            3.0417205,
            3.0438334,
            3.04593076,
            3.04800645,
            3.05006702,
            3.05211169,
            3.05413644,
            3.05614678,
            3.05814059,
            3.06011626,
            3.06207833,
            3.06402303,
            3.065951,
            3.06786709,
            3.06976434,
            3.07164629,
            3.07351816,
            3.07536957,
            3.07720716,
            3.07903574,
            3.0808431,
            3.0826383,
            3.08442481,
            3.08618989,
            3.08794428,
            3.08969015,
            3.09141454,
            3.0931294,
            3.09483602,
            3.09652123,
            3.09819778,
            3.09986647,
            3.10151393,
            3.10315335,
            3.10478423,
            3.10639645,
            3.10799986,
            3.10959431,
            3.11117242,
            3.11274091,
            3.11430023,
            3.11584532,
            3.11737992,
            3.11890537,
            3.12041846,
            3.12192018,
            3.12341295,
            3.12489505,
            3.12636485,
            3.12782606,
            3.12927811,
            3.13071692,
            3.13214766,
            3.1335704,
            3.13497929,
            3.13638059,
            3.13777427,
            3.13915472,
            3.14052758,
            3.141893,
            3.14324587,
            3.14459122,
            3.14592916,
            3.14725528,
            3.14857404,
            3.14988525,
            3.15118541,
            3.15247842,
            3.15376363,
            3.15503859,
            3.15630669,
            3.1575666,
            3.15881709,
            3.16006106,
            3.16129634,
            3.16252294,
            3.16374367,
            3.16495497,
            3.16615827,
            3.16735652,
            3.1685445,
            3.16972518,
            3.17090115,
            3.17206658,
            3.1732256,
            3.17437991,
            3.1755235,
            3.17666139,
            3.17779464,
            3.17891706,
            3.18003434,
            3.18114711,
            3.182249,
            3.18334617,
            3.18443901,
            3.18552099,
            3.18659854,
            3.18767156,
            3.18873466,
            3.18979305,
            3.19084668,
            3.19189155,
            3.19293125,
            3.19396605,
            3.19499317,
            3.19601462,
            3.19703115,
            3.19804097,
            3.1990446,
            3.20004339,
            3.20103635,
            3.20202257,
            3.20300413,
            3.20398065,
            3.20494988,
            3.2059147,
            3.20687519,
            3.20782781,
            3.20877637,
            3.20972079,
            3.21065761,
            3.21159037,
            3.21251906,
            3.21344049,
            3.21435789,
            3.21527119,
            3.21617763,
            3.21708008,
            3.21797834,
            3.21887014,
            3.21975805,
            3.2206416,
            3.22151911,
            3.22239289,
            3.22326204,
            3.22412561,
            3.22498562,
            3.22584069,
            3.22669063,
            3.22753726,
            3.22837856,
            3.22921507,
            3.23004865,
            3.23087648,
            3.23170002,
            3.23252069,
            3.23333545,
            3.23414639,
            3.23495447,
            3.23575649,
            3.23655509,
            3.23735086,
            3.23814047,
            3.23892698,
            3.23971072,
            3.24048826,
            3.24126291,
            3.2420349,
            3.24280067,
            3.2435637,
            3.24432405,
            3.2450785,
            3.24583014,
            3.24657894,
            3.24732252,
            3.24806301,
            3.24880055,
            3.2495335,
            3.25026304,
            3.25098962,
            3.25171216,
            3.25243096,
            3.25314685,
            3.25385921,
            3.25456748,
            3.25527294,
            3.25597533,
            3.25667328,
            3.25736856,
            3.2580612,
            3.25874902,
            3.25943438,
            3.26011727,
            3.26079534,
            3.26147103,
            3.26214426,
            3.26281288,
            3.26347912,
            3.26414287,
            3.26480224,
            3.26545925,
            3.26611371,
            3.26676401,
            3.26741202,
            3.26805734,
            3.26869877,
            3.26933798,
            3.26997434,
            3.27060708,
            3.27123769,
            3.27186524,
            3.27248947,
            3.27311169,
            3.27373059,
            3.2743464,
            3.27496033,
            3.27557077,
            3.27617846,
            3.27678425,
            3.27738643,
            3.27798615,
            3.27858397,
            3.27917808,
            3.27976997,
            3.28035998,
            3.2809462,
            3.28153038,
            3.28211273,
            3.28269124,
            3.28326785,
            3.28384268,
            3.28441366,
            3.28498283,
            3.28555026,
            3.2861139,
            3.28667574,
            3.28723575,
            3.28779239,
            3.28834703,
            3.28889978,
            3.28944955,
            3.28999711,
            3.29054275,
            3.29108578,
            3.29162637,
            3.29216508,
            3.29270148,
            3.29323522,
            3.29376713,
            3.29429704,
            3.29482404,
            3.29534931,
            3.29587284,
            3.2963932,
            3.29691197,
            3.29742915,
            3.29794307,
            3.29845548,
            3.29896631,
            3.29947401,
            3.29998019,
            3.30048477,
            3.30098635,
            3.30148644,
            3.30198487,
            3.30248046,
            3.30297458,
            3.30346695,
            3.30395664,
            3.30444492,
            3.30493133,
            3.30541523,
            3.30589779,
            3.30637832,
            3.30685655,
            3.30733346,
            3.30780821,
            3.30828085,
            3.30875219,
            3.30922127,
            3.30968847,
            3.31015435,
            3.31061787,
            3.31107972,
            3.31154023,
            3.31199831,
            3.31245487,
            3.31291011,
            3.31336287,
            3.31381422,
            3.31426427,
            3.31471181,
            3.31515803,
            3.31560299,
            3.31604542,
            3.31648658,
            3.31692653,
            3.31736394,
            3.31780011,
            3.31823503,
            3.31866764,
            3.3190989,
            3.31952885,
            3.31995677,
            3.32038318,
            3.32080827,
            3.32123157,
            3.3216532,
            3.32207353,
            3.32249228,
            3.3229092,
            3.32332486,
            3.32373914,
            3.32415141,
            3.32456249,
            3.32497237,
            3.32538006,
            3.32578665,
            3.32619218,
            3.32659537,
            3.32699756,
            3.32739869,
            3.32779756,
            3.32819543,
            3.32859222,
            3.32898684,
            3.32938047,
            3.32977298,
            3.33016343,
            3.3305529,
            3.33094118,
            3.33132752,
            3.33171291,
            3.33209702,
            3.33247931,
            3.3328607,
            3.33324069,
            3.333619,
            3.3339964,
            3.33437234,
            3.33474677,
            3.33512024,
            3.33549219,
            3.3358628,
            3.33623242,
            3.33660046,
            3.33696729,
            3.33733313,
            3.33769732,
            3.33806042,
            3.33842253,
            3.33878296,
            3.33914236,
            3.33950081,
            3.33985754,
            3.3402133,
        ]
    )

    policy_egm = np.row_stack([endog_grid, _policy_egm])
    value_egm = np.row_stack([endog_grid, _value_egm])

    return policy_egm, value_egm, policy_out, value_out


def test_fast_upper_envelope_against_org_code():
    policy_egm = np.genfromtxt(TEST_RESOURCES_DIR / "pol10.csv", delimiter=",")
    value_egm = np.genfromtxt(TEST_RESOURCES_DIR / "val10.csv", delimiter=",")

    choice = 0
    max_wealth = 50
    n_grid_wealth = 500
    exogenous_savings_grid = np.linspace(0, max_wealth, n_grid_wealth)

    _index = pd.MultiIndex.from_tuples(
        [("utility_function", "theta"), ("delta", "delta")],
        names=["category", "name"],
    )
    params = pd.DataFrame(data=[1.95, 0.35], columns=["value"], index=_index)
    discount_factor = 1.95

    compute_utility = partial(utility_func_crra, params=params)
    compute_value = partial(
        calc_current_value,
        discount_factor=discount_factor,
        compute_utility=compute_utility,
    )

    policy_refined, value_refined = fast_upper_envelope_wrapper(
        policy=policy_egm,
        value=value_egm,
        exog_grid=exogenous_savings_grid,
        choice=choice,
        n_grid_wealth=len(exogenous_savings_grid),
        compute_value=compute_value,
    )
    policy_org, value_org = fast_upper_envelope_wrapper_org(
        policy=policy_egm,
        value=value_egm,
        exog_grid=exogenous_savings_grid,
        choice=choice,
        n_grid_wealth=len(exogenous_savings_grid),
        compute_value=compute_value,
    )

    policy_got = policy_refined[:, ~np.isnan(policy_refined).any(axis=0)]
    value_got = value_refined[  # noqa: F841
        :,
        ~np.isnan(value_refined).any(axis=0),
    ]
    policy_expected = policy_org[:, ~np.isnan(policy_org).any(axis=0)]
    value_expected = value_org[  # noqa: F841
        :,
        ~np.isnan(value_org).any(axis=0),
    ]

    aaae(policy_got, policy_expected)
    aaae(value_got, value_expected)


@pytest.mark.skip
def test_fast_upper_envelope_against_fedor():
    policy_egm = np.genfromtxt(TEST_RESOURCES_DIR / "pol10.csv", delimiter=",")
    policy_fedor = np.genfromtxt(TEST_RESOURCES_DIR / "expec_pol10.csv", delimiter=",")

    value_egm = np.genfromtxt(TEST_RESOURCES_DIR / "val10.csv", delimiter=",")
    value_fedor = np.genfromtxt(TEST_RESOURCES_DIR / "expec_val10.csv", delimiter=",")

    choice = 0
    max_wealth = 50
    n_grid_wealth = 500
    exogenous_savings_grid = np.linspace(0, max_wealth, n_grid_wealth)

    _index = pd.MultiIndex.from_tuples(
        [("utility_function", "theta"), ("delta", "delta")],
        names=["category", "name"],
    )
    params = pd.DataFrame(data=[1.95, 0.35], columns=["value"], index=_index)
    discount_factor = 1.95

    compute_utility = partial(utility_func_crra, params=params)
    compute_value = partial(
        calc_current_value,
        discount_factor=discount_factor,
        compute_utility=compute_utility,
    )

    policy_refined, value_refined = fast_upper_envelope_wrapper_bug(
        policy=policy_egm,
        value=value_egm,
        exog_grid=exogenous_savings_grid,
        choice=choice,
        n_grid_wealth=len(exogenous_savings_grid),
        compute_value=compute_value,
    )
    _policy_refined_fedor, _value_refine_fedor = upper_envelope(  # noqa: U100
        policy=policy_egm,
        value=value_egm,
        choice=choice,
        n_grid_wealth=len(exogenous_savings_grid),
        compute_value=compute_value,
    )

    policy_got = policy_refined[:, ~np.isnan(policy_refined).any(axis=0)]
    value_got = value_refined[  # noqa: F841
        :,
        ~np.isnan(value_refined).any(axis=0),
    ]
    policy_expected = policy_fedor[:, ~np.isnan(policy_fedor).any(axis=0)]
    value_expected = value_fedor[  # noqa: F841
        :,
        ~np.isnan(value_fedor).any(axis=0),
    ]

    # np.savetxt(
    #     "plot_fues_against_fedor_policy_10_fues.csv",
    #     policy_got,
    #     delimiter="," # noqa: E800
    # ) # noqa: E800
    # np.savetxt(
    #     "plot_fues_against_fedor_policy_10_fedor.csv",
    #     policy_expected, # noqa: E800
    #     delimiter="," # noqa: E800
    # ) # noqa: E800

    fig = plt.figure()
    ax = fig.add_subplot(1, 1, 1)
    ax.plot(policy_expected[0], policy_expected[1], "o", c="g", ms=0.5)
    ax.set_title("refined - Fedor")
    ax.set_xlabel("$m_t$")
    ax.set_ylabel("$c_t$")
    fig.savefig("fedor_pol10.png", dpi=300)

    fig = plt.figure()
    ax = fig.add_subplot(1, 1, 1)
    ax.plot(policy_got[0], policy_got[1], "o", ms=0.5)
    ax.set_title("refined - FUES")
    ax.set_xlabel("$m_t$")
    ax.set_ylabel("$c_t$")
    fig.savefig("fues_pol10.png", dpi=300)

    aaae(policy_got[0], policy_expected[0])


@pytest.mark.skip
def test_upper_envelope(test_data):
    policy_egm, value_egm, policy_expected, value_expected = test_data

    choice = 0
    max_wealth = 50
    n_grid_wealth = 500
    exogenous_savings_grid = np.linspace(0, max_wealth, n_grid_wealth)

    _index = pd.MultiIndex.from_tuples(
        [("utility_function", "theta"), ("delta", "delta")],
        names=["category", "name"],
    )
    params = pd.DataFrame(data=[1.95, 0.35], columns=["value"], index=_index)
    discount_factor = 1.95

    compute_utility = partial(utility_func_crra, params=params)
    compute_value = partial(
        calc_current_value,
        discount_factor=discount_factor,
        compute_utility=compute_utility,
    )

    policy_refined, value_refined = fast_upper_envelope_wrapper_bug(
        policy=policy_egm,
        value=value_egm,
        exog_grid=exogenous_savings_grid,
        choice=choice,
        n_grid_wealth=len(exogenous_savings_grid),
        compute_value=compute_value,
    )

    policy_got = policy_refined[:, ~np.isnan(policy_refined).any(axis=0)]
    value_got = value_refined[
        :,
        ~np.isnan(value_refined).any(axis=0),
    ]

    aaae(policy_got, policy_expected)
    aaae(value_got, value_expected)


@pytest.mark.skip
def test_credit_constrained():
    choice = 0
    max_wealth = 50
    n_grid_wealth = 500
    exogenous_savings_grid = np.linspace(0, max_wealth, n_grid_wealth)

    _index = pd.MultiIndex.from_tuples(
        [("utility_function", "theta"), ("delta", "delta")],
        names=["category", "name"],
    )
    params = pd.DataFrame(data=[1.95, 0.35], columns=["value"], index=_index)
    discount_factor = 0.95  # beta

    compute_utility = partial(utility_func_crra, params=params)
    compute_value = partial(
        calc_current_value,
        discount_factor=discount_factor,
        compute_utility=compute_utility,
    )

    policy_egm = np.genfromtxt(
        TEST_RESOURCES_DIR / "policy_egm_credit_constrained.csv", delimiter=","
    )
    value_egm = np.genfromtxt(
        TEST_RESOURCES_DIR / "value_egm_credit_constrained.csv", delimiter=","
    )

    policy_refined, value_refined = fast_upper_envelope_wrapper_bug(
        policy=policy_egm,
        value=value_egm,
        exog_grid=exogenous_savings_grid,
        choice=choice,
        n_grid_wealth=len(exogenous_savings_grid),
        compute_value=compute_value,
    )
    _ = policy_refined[:, ~np.isnan(policy_refined).any(axis=0)]
    _ = value_refined[
        :,
        ~np.isnan(value_refined).any(axis=0),
    ]
